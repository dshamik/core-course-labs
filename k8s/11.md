# Secrets

## Task 1

### Kubectl

```shell
~ kubectl apply -f secret.yaml
secret/secret-base created

~ kubectl get secrets secret-base -o jsonpath='{.data.password}' | base64 -d
smth in base64 format
```

### Helm

I use Windows woth PowerShell, therefore I used `Select-String` instead of `grep`

```shell
~ kubectl get po
NAME                             READY   STATUS    RESTARTS   AGE
python-my-app-7df844cc9d-7l58j   1/1     Running   0          46s

~ kubectl exec python-my-app-7df844cc9d-7l58j -- printenv | grep PASSWORD
PASSWORD=smth in base64 format
```

## Task 2

### Install

```shell
~ helm install vault hashicorp/vault --set "server.dev.enabled=true"
NAME: vault
LAST DEPLOYED: Tue Nov 14 21:44:56 2023
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
Thank you for installing HashiCorp Vault!

Now that you have deployed Vault, you should look over the docs on using
Vault with Kubernetes available here:

https://developer.hashicorp.com/vault/docs


Your release is named vault. To learn more about the release, try:

  $ helm status vault
  $ helm get manifest vault

~ kubectl get pods
NAME                                    READY   STATUS              RESTARTS   AGE
python-my-app-7df844cc9d-7l58j          1/1     Running             0          5m12s
vault-0                                 0/1     ContainerCreating   0          7s
vault-agent-injector-5cd8b87c6c-8ksmg   0/1     ContainerCreating   0          8s```
```

### Configuration

#### Secret

```shell
~ kubectl exec -it vault-0 -- /bin/sh
/ $ vault secrets enable -path=internal kv-v2
Success! Enabled the kv-v2 secrets engine at: internal/
/ $ vault kv put internal/database/config username="db-readonly-username" password="db-secret-passwo
rd"
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2023-11-14T18:58:34.415189686Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1
/ $ vault kv get internal/database/config
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2023-11-14T18:58:34.415189686Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1

====== Data ======
Key         Value
---         -----
password    db-secret-password
username    db-readonly-username
```

#### Kubernetes authentication

```
kubectl exec -it vault-0 -- /bin/sh
/ $ vault secrets enable -path=internal kv-v2
Success! Enabled the kv-v2 secrets engine at: internal/
/ $ vault kv put internal/database/config username="db-readonly-username" password="db-secret-passwo
rd"
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2023-11-14T18:58:34.415189686Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1
/ $ vault kv get internal/database/config
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2023-11-14T18:58:34.415189686Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1

====== Data ======
Key         Value
---         -----
password    db-secret-password
username    db-readonly-username
/ $ exit
âžœ  my-app kubectl exec -it vault-0 -- /bin/sh
/ $ vault auth enable kubernetes
Success! Enabled kubernetes auth method at: kubernetes/
/ $ vault write auth/kubernetes/config \
> kubernetes_host="https://$KUBERNETES_PORT_443_TCP_ADDR:443"
Success! Data written to: auth/kubernetes/config
/ $ vault policy write internal-app - <<EOF
> path "internal/data/database/config" {
>    capabilities = ["read"]
> }
> EOF
Success! Uploaded policy: internal-app
/ $ vault write auth/kubernetes/role/internal-app \
>       bound_service_account_names=internal-app \
>       bound_service_account_namespaces=default \
>       policies=internal-app \
>       ttl=24h
Success! Data written to: auth/kubernetes/role/internal-app
/ $ exit
```

#### Check

```
~ kubectl get sa -n default
NAME                   SECRETS   AGE
default                0         13d
internal-app           0         9m42s
vault                  0         18m
vault-agent-injector   0         18m

~ kubectl get pods
NAME                                    READY   STATUS     RESTARTS   AGE
python-my-app-b589cfc64-rrs2j           0/2     Init:0/1   0          10m
vault-0                                 1/1     Running    0          18m
vault-agent-injector-5cd8b87c6c-8ksmg   1/1     Running    0          18m

~ kubectl exec python-my-app-b589cfc64-rrs2j -it /bin/sh
kubectl exec [POD] [COMMAND] is DEPRECATED and will be removed in a future version. Use kubectl exec [POD] -- [COMMAND] instead.
Defaulted container "my-app" out of: my-app, vault-agent, vault-agent-init (init)
/app $ cat /vault/secrets/database-config.txt
data: map[password:db-secret-password username:db-readonly-username]
metadata: map[created_time:2023-11-14T18:58:34.415189686Z custom_metadata:<nil> deletion_time: destroyed:false version:1]
/app $ exit
```